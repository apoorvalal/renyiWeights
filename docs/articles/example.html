<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Renyi divergence weights for Causal Inference and Reweighting â€¢ renyiWeights</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Renyi divergence weights for Causal Inference and Reweighting">
<meta property="og:description" content="renyiWeights">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">renyiWeights</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/example.html">Renyi divergence weights for Causal Inference and Reweighting</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Renyi divergence weights for Causal Inference
and Reweighting</h1>
                        <h4 data-toc-skip class="author">Apoorva
Lal</h4>
            
            <h4 data-toc-skip class="date">July 19, 2022</h4>
      
      
      <div class="hidden name"><code>example.Rmd</code></div>

    </div>

    
    
<!--- For HTML renders - selection from math_shortcuts.tex --->
<p><span class="math inline">\(\DeclareMathOperator*{\argmin}{argmin}\)</span>
<span class="math inline">\(\newcommand{\var}{\mathrm{Var}}\)</span>
<span class="math inline">\(\newcommand{\epsi}{\varepsilon}\)</span>
<span class="math inline">\(\newcommand{\phii}{\varphi}\)</span> <span class="math inline">\(\newcommand{\tra}{^{\top}}\)</span> <span class="math inline">\(\newcommand{\sumin}{\sum_{i=1}^n}\)</span> <span class="math inline">\(\newcommand{\sumiN}{\sum_{i=1}^n}\)</span> <span class="math inline">\(\newcommand{\norm}[1]{\left\Vert{#1}
\right\Vert}\)</span> <span class="math inline">\(\newcommand\Bigpar[1]{\left( #1 \right )}\)</span>
<span class="math inline">\(\newcommand\Bigbr[1]{\left[ #1 \right
]}\)</span> <span class="math inline">\(\newcommand\Bigcr[1]{\left\{ #1
\right \}}\)</span> <span class="math inline">\(\newcommand\SetB[1]{\left\{ #1 \right\}}\)</span>
<span class="math inline">\(\newcommand\Sett[1]{\mathcal{#1}}\)</span>
<span class="math inline">\(\newcommand{\Data}{\mathcal{D}}\)</span>
<span class="math inline">\(\newcommand{\Ubr}[2]{\underbrace{#1}_{\text{#2}}}\)</span>
<span class="math inline">\(\newcommand{\Obr}[2]{
\overbrace{#1}^{\text{#2}}}\)</span> <span class="math inline">\(\newcommand{\sumiN}{\sum_{i=1}^N}\)</span> <span class="math inline">\(\newcommand{\dydx}[2]{\frac{\partial #1}{\partial
#2}}\)</span> <span class="math inline">\(\newcommand\Indic[1]{\mathds{1}_{#1}}\)</span>
<span class="math inline">\(\newcommand{\Realm}[1]{\mathbb{R}^{#1}}\)</span>
<span class="math inline">\(\newcommand{\Exp}[1]{\mathbb{E}\left[#1\right]}\)</span>
<span class="math inline">\(\newcommand{\Expt}[2]{\mathbb{E}_{#1}\left[#2\right]}\)</span>
<span class="math inline">\(\newcommand{\Var}[1]{\mathbb{V}\left[#1\right]}\)</span>
<span class="math inline">\(\newcommand{\Covar}[1]{\text{Cov}\left[#1\right]}\)</span>
<span class="math inline">\(\newcommand{\Prob}[1]{\mathbf{Pr}\left(#1\right)}\)</span>
<span class="math inline">\(\newcommand{\Supp}[1]{\text{Supp}\left[#1\right]}\)</span>
<span class="math inline">\(\newcommand{\doyx}{\Prob{Y \, |\,\mathsf{do}
(X = x)}}\)</span> <span class="math inline">\(\newcommand{\doo}[1]{\Prob{Y |\,\mathsf{do} (#1)
}}\)</span> <span class="math inline">\(\newcommand{\R}{\mathbb{R}}\)</span> <span class="math inline">\(\newcommand{\Z}{\mathbb{Z}}\)</span> <span class="math inline">\(\newcommand{\wh}[1]{\widehat{#1}}\)</span> <span class="math inline">\(\newcommand{\wt}[1]{\widetilde{#1}}\)</span> <span class="math inline">\(\newcommand{\wb}[1]{\overline{#1}}\)</span> <span class="math inline">\(\newcommand\Ol[1]{\overline{#1}}\)</span> <span class="math inline">\(\newcommand\Ul[1]{\underline{#1}}\)</span> <span class="math inline">\(\newcommand\Str[1]{#1^{*}}\)</span> <span class="math inline">\(\newcommand{\F}{\mathsf{F}}\)</span> <span class="math inline">\(\newcommand{\ff}{\mathsf{f}}\)</span> <span class="math inline">\(\newcommand{\Cdf}[1]{\mathbb{F}\left(#1\right)}\)</span>
<span class="math inline">\(\newcommand{\Cdff}[2]{\mathbb{F}_{#1}\left(#2\right)}\)</span>
<span class="math inline">\(\newcommand{\Pdf}[1]{\mathsf{f}\left(#1\right)}\)</span>
<span class="math inline">\(\newcommand{\Pdff}[2]{\mathsf{f}_{#1}\left(#2\right)}\)</span>
<span class="math inline">\(\newcommand{\dd}{\mathsf{d}}\)</span> <span class="math inline">\(\newcommand\Normal[1]{\mathcal{N} \left( #1 \right
)}\)</span> <span class="math inline">\(\newcommand\Unif[1]{\mathsf{U}
\left[ #1 \right ]}\)</span> <span class="math inline">\(\newcommand\Bern[1]{\mathsf{Bernoulli} \left( #1
\right )}\)</span> <span class="math inline">\(\newcommand\Binom[1]{\mathsf{Bin} \left( #1 \right
)}\)</span> <span class="math inline">\(\newcommand\Pois[1]{\mathsf{Poi}
\left( #1 \right )}\)</span> <span class="math inline">\(\newcommand\BetaD[1]{\mathsf{Beta} \left( #1
\right )}\)</span> <span class="math inline">\(\newcommand\Diri[1]{\mathsf{Dir} \left( #1 \right
)}\)</span> <span class="math inline">\(\newcommand\Gdist[1]{\mathsf{Gamma} \left( #1
\right )}\)</span> <span class="math inline">\(\def\mbf#1{\mathbf{#1}}\)</span> <span class="math inline">\(\def\mrm#1{\mathrm{#1}}\)</span> <span class="math inline">\(\def\mbi#1{\boldsymbol{#1}}\)</span> <span class="math inline">\(\def\ve#1{\mbi{#1}}\)</span> <span class="math inline">\(\def\vee#1{\mathbf{#1}}\)</span> <span class="math inline">\(\newcommand{\Mat}[1]{\mathbf{#1}}\)</span> <span class="math inline">\(\newcommand{\eucN}[1]{\norm{#1}}\)</span> <span class="math inline">\(\newcommand{\lzero}[1]{\norm{#1}_0}\)</span> <span class="math inline">\(\newcommand{\lone}[1]{\norm{#1}_1}\)</span> <span class="math inline">\(\newcommand{\ltwo}[1]{\norm{#1}_2}\)</span> <span class="math inline">\(\newcommand{\pnorm}[1]{\norm{#1}_p}\)</span></p>
<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
</style>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># for lalonde data</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">LalRUtils</span><span class="op">)</span>
<span class="co"># load library</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">renyiWeights</span><span class="op">)</span></code></pre></div>
<p>This package extends the functionality in <code>ebal</code> to a
larger set of divergence measures and accommodates a general set of
estimands.</p>
<p>The <code>ebal</code> package is restricted to computing ATT since it
expects a treatment vector and data matrix and solves for weights that
set the covariate means in the control group to those in the treatment
group. <code><a href="../reference/entrBal.html">renyiWeights::entrBal</a></code> expects a data matrix
<code>X</code> and a target means vector <code>target</code>, which can
accommodate a wide variety of estimands:</p>
<ul>
<li>treatment group mean for ATT</li>
<li>overall sample mean for ATE</li>
<li>subgroup means for CATE</li>
<li>out-of-sample means for generalizability / survey reweighting</li>
</ul>
<p>The weights it produces can then be used in a linear regression
without covariates.</p>
<div class="section level2">
<h2 id="renyi-divergence">Renyi Divergence<a class="anchor" aria-label="anchor" href="#renyi-divergence"></a>
</h2>
<p>Many problems involve reweighting a source sample <span class="math inline">\(\mathcal{S}\)</span> to resemble a target sample
<span class="math inline">\(\mathcal{T}\)</span> by solving moment
conditions. These problems can be cast into the following form:</p>
<p><span class="math display">\[
\text{min}_{w} D (w || d)
\]</span></p>
<p>subject to balance constraints <span class="math display">\[
  \sum_{i : i \in \mathcal{S}} w_i c_{ri}(\mathbf{X}_i) =  m_r(X_j)
\text{ with } r \in 1, \dots, R
\]</span></p>
<p>and normalization <span class="math display">\[
  \sum_{i : i \in \mathcal{S}} w_i = | \mathcal{S}|
\]</span></p>
<p>Many candidate <span class="math inline">\(D(w || d)\)</span>
distance metrics exist. A popular one is the KL divergence, which is
given by</p>
<p><span class="math display">\[
D_1(w || d) = \sum_{i \in \mathcal{S}} w_i \log (w_i / d_i)
\]</span></p>
<p>Similarly, one may also choose</p>
<p><span class="math display">\[
D_2(w || d) = \log \left ( \sum_{i \in \mathcal{S}} w^2 /d_i  \right)
\]</span></p>
<p>These are both special cases of the Renyi family of divergences</p>
<p><span class="math display">\[
D(w || d) = D_\alpha(w || d) = \frac{1}{\alpha - 1} \log
  \left( \sum_{i \in \mathcal{S}} \frac{w_i^\alpha}{d_i^{\alpha - 1}}
\right)
\]</span></p>
<p>This package supports <span class="math inline">\(D_1, D_2\)</span>
and more are in progress (although <span class="math inline">\(D_1\)</span> should suffice for most applications,
especially since it is computationally attractive).</p>
</div>
<div class="section level2">
<h2 id="entropy-balancing">Entropy Balancing<a class="anchor" aria-label="anchor" href="#entropy-balancing"></a>
</h2>
<p>The Entropy balancing section builds on Hainmueller(2012) and
accompanying r package <code>ebal</code>.</p>
<p>Entropy balancing for causal inference involves solving for balancing
weights <span class="math inline">\(w_i\)</span> that solves the
following (convex) program</p>
<p><span class="math display">\[\begin{align*}
  \max_{\mathbf{w}} H(w) &amp;= - \sum_{i : i \in \mathcal{S} } w_i \log
w_i \\
  \text{Balance constraints:} &amp; \sum_{i : i \in \mathcal{S}} w_i
c_{ri}(\mathbf{X}_i) =  m_r(X_j) \text{ with } r \in 1, \dots, R   \\
  \text{Proper weights:} &amp; \sum_{i : i \in \mathcal{S}} w_i = 1 \;
\; \text{and } w_i \geq
  0 \; \forall \; \{i: i \in \mathcal{S} \}
\end{align*}\]</span></p>
<p>This convex program has <span class="math inline">\(R\)</span>
balance constraints that seek to equate functions <span class="math inline">\(c_{ri}(X_i)\)</span> in a source sample <span class="math inline">\(\mathcal{S}\)</span> to a target value <span class="math inline">\(m_r\)</span>. This primal problem has dimension
<span class="math inline">\(n_0 + R + 1\)</span>.</p>
<div class="section level3">
<h3 id="dual-formulation">Dual Formulation<a class="anchor" aria-label="anchor" href="#dual-formulation"></a>
</h3>
<p>Duality holds in the Lagrangian for the above problem and constraints
can be substituted out. The solution for each weight is attained by</p>
<p><span class="math display">\[
w_i^* = exp \left(  - \sum_{r =1}^R \lambda_r c_{ri} (\mathbf{X}_i)
\right)
\]</span></p>
<p>where <span class="math inline">\(Z = \{\lambda_1, \dots,
\lambda_R\}'\)</span> is a vector of Lagrange multipliers for the
Lagrangian.</p>
<p>Relevant extract from Hainmueller (2012):</p>
<p><img src="figs/hain_2012_dual.png"></p>
<p>The dual Lagrangian has a much smaller dimension of <span class="math inline">\(R\)</span> and can be solved fast using Newtonâ€™s
method. We demonstrate the speed gains below in benchmarking.</p>
</div>
<div class="section level3">
<h3 id="basics-computing-average-treatment-effect-on-the-treated-att">Basics : computing Average Treatment effect on the Treated
(ATT)<a class="anchor" aria-label="anchor" href="#basics-computing-average-treatment-effect-on-the-treated-att"></a>
</h3>
<p>In the most straightforward example of entropy balancing, we seek to
reweight control observations <span class="math inline">\(\{i: D_i =
0\}\)</span> to match sample moments in the treated sample in order to
compute <span class="math inline">\(\Exp{Y^1 - Y^0 | D = 1}\)</span>
where the second counterfactual mean <span class="math inline">\(\Exp{Y^0|D=1}\)</span> is computed as a reweighted
mean of the control group <span class="math inline">\(\sum_{i: D_i = 0}
w_i Y_i\)</span>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># %%</span>
<span class="co">############################################################</span>
<span class="co"># ATT</span>
<span class="co">############################################################</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">lalonde.psid</span><span class="op">)</span>; <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setDT.html" class="external-link">setDT</a></span><span class="op">(</span><span class="va">lalonde.psid</span><span class="op">)</span>; <span class="va">df</span> <span class="op">=</span> <span class="va">lalonde.psid</span>
<span class="va">yn</span> <span class="op">=</span> <span class="st">'re78'</span>; <span class="va">wn</span> <span class="op">=</span> <span class="st">'treat'</span>; <span class="va">Xn</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setops.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">yn</span>, <span class="va">wn</span><span class="op">)</span><span class="op">)</span>

<span class="co"># rest of the code is generic</span>
<span class="va">X</span> <span class="op">=</span> <span class="va">df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">wn</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span>, <span class="va">..Xn</span><span class="op">]</span> |&gt; <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span>
<span class="co"># treatment covariate means (for ATT)</span>
<span class="va">target</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/matrixStats/man/rowMeans2.html" class="external-link">colMeans2</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">wn</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">..Xn</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>

<span class="co"># solve for balancing weights (solves dual by default)</span>
<span class="va">Ï‰</span> <span class="op">=</span> <span class="fu"><a href="../reference/entrBal.html">entrBal</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">target</span><span class="op">)</span>

<span class="co"># weighted regression (for robust standard errors)</span>
<span class="va">regdf</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">rbind</a></span><span class="op">(</span>
  <span class="co"># treated obs : uniform weights</span>
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">wn</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">yn</span><span class="op">)</span><span class="op">]</span>, w <span class="op">=</span> <span class="fl">1</span>, wt <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://www.cvxgrp.org/CVXR/reference/sum_entries.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">df</span><span class="op">[[</span><span class="va">wn</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,
  <span class="co"># untreated obs : solved weights</span>
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">wn</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">yn</span><span class="op">)</span><span class="op">]</span>, w <span class="op">=</span> <span class="fl">0</span>, wt <span class="op">=</span> <span class="va">Ï‰</span><span class="op">)</span>
<span class="op">)</span>
<span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html" class="external-link">feols</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">w</span>, weights <span class="op">=</span> <span class="op">~</span><span class="va">wt</span>, data <span class="op">=</span> <span class="va">regdf</span>, vcov <span class="op">=</span> <span class="st">"HC1"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## OLS estimation, Dep. Var.: y</span>
<span class="co">## Observations: 2,675 </span>
<span class="co">## Standard-errors: Heteroskedasticity-robust </span>
<span class="co">##             Estimate Std. Error t value   Pr(&gt;|t|)    </span>
<span class="co">## (Intercept)  3924.49    659.777 5.94821 3.0644e-09 ***</span>
<span class="co">## w            2424.66    876.538 2.76618 5.7108e-03 ** </span>
<span class="co">## ---</span>
<span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">## RMSE: 205.2   Adj. R2: 0.025064</span></code></pre>
<div class="section level4">
<h4 id="compare-primal-and-dual-solutions">Compare primal and dual solutions<a class="anchor" aria-label="anchor" href="#compare-primal-and-dual-solutions"></a>
</h4>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># %% check that primal and dual solutions are identical</span>
<span class="va">Ï‰_primal</span> <span class="op">=</span> <span class="fu"><a href="../reference/eb_solve_primal.html">eb_solve_primal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">target</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">X</span><span class="op">)</span><span class="op">)</span>
<span class="va">Ï‰s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Ï‰</span>, <span class="va">Ï‰_primal</span><span class="op">)</span>
<span class="co"># should lie along 45Â° line</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">Ï‰s</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">Ï‰s</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></code></pre></div>
<p><img src="example_files/figure-html/diagfig-1.png" width="700" style="display: block; margin: auto;"></p>
<p>As expected, the weights are identical.</p>
</div>
</div>
<div class="section level3">
<h3 id="other-estimands-ate">Other Estimands: ATE<a class="anchor" aria-label="anchor" href="#other-estimands-ate"></a>
</h3>
<p>For the ATE, we need to reweight <em>both</em> treatment and control
groups to equate covariate averages to the overall sample average.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># %%</span>
<span class="co">############################################################</span>
<span class="co"># ATE</span>
<span class="co">############################################################</span>

<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">lalonde.exp</span><span class="op">)</span>; <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setDT.html" class="external-link">setDT</a></span><span class="op">(</span><span class="va">lalonde.exp</span><span class="op">)</span>; <span class="va">df</span> <span class="op">=</span> <span class="va">lalonde.exp</span>
<span class="va">yn</span> <span class="op">=</span> <span class="st">'re78'</span>; <span class="va">wn</span> <span class="op">=</span> <span class="st">'treat'</span>; <span class="va">Xn</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setops.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">yn</span>, <span class="va">wn</span><span class="op">)</span><span class="op">)</span>

<span class="va">X0</span> <span class="op">=</span> <span class="va">df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">wn</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span>, <span class="va">..Xn</span><span class="op">]</span> |&gt; <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">X1</span> <span class="op">=</span> <span class="va">df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">wn</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">..Xn</span><span class="op">]</span> |&gt; <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># overall covariate means (for ATE)</span>
<span class="va">target2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/matrixStats/man/rowMeans2.html" class="external-link">colMeans2</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">df</span><span class="op">[</span>, <span class="va">..Xn</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>

<span class="co"># solve for balancing weights - treatment obs</span>
<span class="va">Ï‰1</span> <span class="op">=</span> <span class="fu"><a href="../reference/entrBal.html">entrBal</a></span><span class="op">(</span><span class="va">X1</span>, <span class="va">target2</span><span class="op">)</span>
<span class="va">Ï‰0</span> <span class="op">=</span> <span class="fu"><a href="../reference/entrBal.html">entrBal</a></span><span class="op">(</span><span class="va">X0</span>, <span class="va">target2</span><span class="op">)</span>

<span class="va">regdf</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">rbind</a></span><span class="op">(</span>
  <span class="co"># treated obs : uniform weights of 1</span>
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">wn</span><span class="op">)</span><span class="op">==</span> <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">yn</span><span class="op">)</span><span class="op">]</span>, w <span class="op">=</span> <span class="fl">1</span>, wt <span class="op">=</span> <span class="va">Ï‰1</span><span class="op">)</span>,
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">wn</span><span class="op">)</span><span class="op">==</span> <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">yn</span><span class="op">)</span><span class="op">]</span>, w <span class="op">=</span> <span class="fl">0</span>, wt <span class="op">=</span> <span class="va">Ï‰0</span><span class="op">)</span>
<span class="op">)</span>

<span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html" class="external-link">feols</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">w</span>, weights <span class="op">=</span> <span class="op">~</span><span class="va">wt</span>, data <span class="op">=</span> <span class="va">regdf</span>, vcov <span class="op">=</span> <span class="st">"HC1"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## OLS estimation, Dep. Var.: y</span>
<span class="co">## Observations: 445 </span>
<span class="co">## Standard-errors: Heteroskedasticity-robust </span>
<span class="co">##             Estimate Std. Error  t value  Pr(&gt;|t|)    </span>
<span class="co">## (Intercept)  4590.56    353.320 12.99265 &lt; 2.2e-16 ***</span>
<span class="co">## w            1571.81    689.266  2.28042  0.023057 *  </span>
<span class="co">## ---</span>
<span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">## RMSE: 453.8   Adj. R2: 0.011074</span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="speed-comparison">Speed comparison<a class="anchor" aria-label="anchor" href="#speed-comparison"></a>
</h2>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/microbenchmark/" class="external-link">microbenchmark</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span>
  eb_primal <span class="op">=</span> <span class="op">{</span>
    <span class="fu"><a href="../reference/eb_solve_primal.html">eb_solve_primal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">target</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">X</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>,
  eb_dual <span class="op">=</span> <span class="op">{</span>
    <span class="fu"><a href="../reference/eb_solve_dual.html">eb_solve_dual</a></span><span class="op">(</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">target</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">X</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>,
  qr_primal <span class="op">=</span> <span class="op">{</span>
    <span class="fu"><a href="../reference/qr_solve_primal.html">qr_solve_primal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">target</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">X</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>,
  times <span class="op">=</span> <span class="fl">100L</span>
<span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Unit: milliseconds</span>
<span class="co">##       expr         min          lq        mean      median          uq</span>
<span class="co">##  eb_primal  323.923267  331.831341  379.005292  339.889250  354.380031</span>
<span class="co">##    eb_dual    8.373995    8.533503    9.267221    8.719521    9.244629</span>
<span class="co">##  qr_primal 1439.743452 1740.925114 1839.687712 1758.990169 1833.185587</span>
<span class="co">##         max neval cld</span>
<span class="co">##   732.00169   100  b </span>
<span class="co">##    16.17057   100 a  </span>
<span class="co">##  2948.89522   100   c</span></code></pre>
<p>The dual solver is much faster than the primal for EB.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Apoorva Lal.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.5.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
